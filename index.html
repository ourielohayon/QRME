<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>QRME</title>

    <link rel="icon" type="image/png" href="/apple-touch-icon.png?v=5">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png?v=5">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --theme-base: #1c3e7d; 
            --bg-gradient: linear-gradient(180deg, var(--theme-base) 0%, #000000 100%);
            
            /* Brand Colors */
            --linkedin-color: #0077B5; --telegram-color: #24A1DE; --whatsapp-color: #25D366;
            --twitter-color: #000000; --instagram-color: #C13584; --youtube-color: #FF0000;
            --discord-color: #5865F2; --github-color: #333333; --wifi-color: #5856D6;
            --bitcoin-color: #F7931A; --vcard-color: #333333; --share-app-color: #4B0082;
            --calendly-color: #006BFF; --custom-color: #FF9500;

            --card-bg: rgba(255, 255, 255, 0.94); 
            --text-primary: #000000;
            --ease: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { background-color: #000000; height: 100%; width: 100%; overflow: hidden; }
        
        body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background: transparent; overflow: hidden;
            display: flex; justify-content: center;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .app-background {
            position: fixed; top: -10vh; left: -10vw; width: 120vw; height: 120vh;
            background: var(--bg-gradient); z-index: -10; transition: background 0.6s ease;
        }

        #app { width: 100%; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; }

        /* Icon Styles */
        .settings-icon {
            position: absolute; top: 20px; right: 25px; z-index: 100;
            color: rgba(255,255,255,0.6); padding: 10px; cursor: pointer;
        }
        .gear-svg { width: 24px; height: 24px; fill: currentColor; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }

        .camera-icon {
            position: absolute; top: 20px; right: 25px; z-index: 100;
            color: rgba(255,255,255,0.9); padding: 10px; cursor: pointer;
            display: none; /* Hidden by default */
        }
        .camera-svg { width: 28px; height: 28px; fill: currentColor; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        #camera-input { display: none; }

        /* Views */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: opacity 0.3s var(--ease), transform 0.3s var(--ease);
        }
        .view.active { opacity: 1; pointer-events: all; transform: scale(1); }

        /* Profile */
        .profile-container { margin-bottom: 15px; position: relative; }
        .profile-pic {
            width: 90px; height: 90px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2);
            object-fit: cover; box-shadow: 0 8px 20px rgba(0,0,0,0.3); display: none; 
        }
        .profile-placeholder {
            width: 90px; height: 90px; border-radius: 50%;
            background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: rgba(255,255,255,0.8); border: 2px solid rgba(255,255,255,0.1);
        }

        /* Buttons & Grid */
        .copy-intro-btn {
            background: rgba(255, 255, 255, 0.2); color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px;
            padding: 12px 20px; width: 100%; max-width: 360px;
            font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 15px; cursor: pointer;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            transition: background 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .copy-intro-btn:active { background: rgba(255, 255, 255, 0.3); transform: scale(0.98); }
        .copy-icon { width: 18px; height: 18px; }

        .grid-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            width: 100%; max-width: 360px; padding: 0 25px;
            max-height: 60vh; overflow-y: auto;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .grid-container::-webkit-scrollbar { display: none; }

        .app-icon {
            background: var(--card-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 18px; padding: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
            transition: transform 0.1s; height: 90px; 
        }
        .app-icon:active { transform: scale(0.96); opacity: 0.9; }

        .icon-svg { width: 30px; height: 30px; display: block; }
        .icon-label { font-size: 13px; font-weight: 600; text-align: center; color: #000; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; }

        /* Icon Colors */
        .linkedin .icon-svg { fill: var(--linkedin-color); }
        .telegram .icon-svg { fill: var(--telegram-color); }
        .whatsapp .icon-svg { fill: var(--whatsapp-color); }
        .twitter .icon-svg { fill: var(--twitter-color); }
        .instagram .icon-svg { fill: var(--instagram-color); }
        .youtube .icon-svg { fill: var(--youtube-color); }
        .discord .icon-svg { fill: var(--discord-color); }
        .github .icon-svg { fill: var(--github-color); }
        .wifi .icon-svg { fill: var(--wifi-color); }
        .bitcoin .icon-svg { fill: var(--bitcoin-color); }
        .vcard .icon-svg { fill: var(--vcard-color); }
        .share-app .icon-svg { fill: var(--share-app-color); }
        .calendly .icon-svg { fill: var(--calendly-color); }
        .custom .icon-svg { fill: var(--custom-color); }

        /* QR View */
        #qr-view { gap: 15px; }
        .qr-card {
            background: rgba(255,255,255,0.95); padding: 25px; border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); width: 260px;
        }
        #qrcode { width: 180px; height: 180px; background: white; border-radius: 4px; overflow: hidden; }
        #qrcode img { width: 100%; height: 100%; display: block; }
        .qr-label { font-size: 20px; font-weight: 700; text-align: center; margin: 0; }

        .action-btn {
            background: #007AFF; color: white; border: none; padding: 10px;
            font-size: 14px; font-weight: 600; border-radius: 10px; width: 100%;
            display: flex; justify-content: center; align-items: center; gap: 6px;
            cursor: pointer;
        }
        
        .open-app-btn {
            background: transparent; color: #007AFF; 
            border: 2px solid #007AFF; 
            margin-top: -5px; 
        }
        .open-app-btn:active { background: rgba(0,122,255,0.1); }

        .vcard-dl-btn {
            background: #333; color: white;
            margin-top: -5px; 
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.15); color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.15); padding: 8px 24px;
            font-size: 15px; font-weight: 500; border-radius: 50px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }

        /* Settings Form */
        .setup-form {
            background: #fff; padding: 20px; border-radius: 20px;
            width: 95%; max-width: 400px;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 15px;
        }
        .setup-form h2 { margin: 0 0 5px; color: #000; font-size: 20px; text-align: center; }
        
        .settings-section {
            background: linear-gradient(180deg, #f0f9ff 0%, #e0f7fa 100%);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e0e7ff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .section-title {
            font-size: 11px; font-weight: 800; color: #1c3e7d; 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 6px;
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 4px; }
        .input-group { margin-bottom: 0; }
        .full-width { grid-column: span 2; }

        .input-group label { display: block; font-size: 10px; color: #555; margin-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 10px; background: #fff; border: 1px solid #ccc; 
            border-radius: 8px; font-size: 14px; -webkit-appearance: none;
            box-sizing: border-box;
        }
        
        .loc-row { display: flex; gap: 5px; }
        .loc-btn { width: 45px; background: #007AFF; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .file-btn { background: #fff; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; width: 100%; display:block; border: 1px solid #d1d5db; color:#333; }
        
        .save-btn { width: 100%; padding: 14px; background: #000; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 10px; transition: background 0.3s; cursor: pointer; }

        .data-btns { display: flex; gap: 10px; margin-top: 5px; }
        .data-btn { flex: 1; padding: 10px; background: #fff; color: #333; border: 1px solid #ccc; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; }

        .theme-grid { display: flex; gap: 8px; justify-content: space-between; flex-wrap: wrap; margin-top: 5px; }
        .theme-swatch {
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .theme-swatch.active { border-color: #000; transform: scale(1.1); }
        .color-picker-wrapper {
            width: 32px; height: 32px; border-radius: 50%; overflow: hidden; position: relative; cursor: pointer; border: 2px solid #ddd; background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
        }
        .color-picker-input { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; opacity: 0; cursor: pointer; }

        /* Greeting Editor */
        #greeting-editor { display: none; margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px; width: 100%; }
        /* Fix Width */
        #in-greeting { width: 100%; box-sizing: border-box; font-family: sans-serif; min-height: 80px; }
        
        .greeting-btn { background: #fff; color: #007AFF; margin-top: 5px; width: 100%; font-size: 12px; font-weight: 600; border-radius: 8px; padding: 10px; border: 1px solid #bae6fd; cursor: pointer; }
        .regen-btn { background: #f1f5f9; color: #64748b; font-size: 11px; padding: 8px; border-radius: 6px; border: none; margin-top: 8px; cursor: pointer; width: 100%; }

        /* Custom Links */
        .custom-link-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
        .add-link-btn { background: #fff; color: #007AFF; border: 1px dashed #007AFF; padding: 10px; border-radius: 8px; width: 100%; cursor: pointer; font-size: 12px; font-weight: 600; }

        .footnote { 
            position: absolute; bottom: 15px; width: 100%; 
            display: flex; justify-content: center; align-items: center; gap: 8px;
            color: #ffffff; font-size: 11px; font-weight: 500; pointer-events: auto; 
        }
        .footnote a { color: white; text-decoration: none; display: flex; align-items: center; }
        .github-footer-icon { width: 16px; height: 16px; fill: white; opacity: 0.8; transition: opacity 0.2s; }
        .github-footer-icon:hover { opacity: 1; }
    </style>
</head>
<body>

    <div class="app-background" id="bg-layer"></div>

    <div id="app">
        <!-- Settings Icon -->
        <div id="settings-btn" class="settings-icon" onclick="window.showSetup()">
            <svg class="gear-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        </div>

        <!-- Camera Icon (Shown in QR View) -->
        <div id="camera-btn" class="camera-icon" onclick="document.getElementById('camera-input').click()">
            <svg class="camera-svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm8-12H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H4V4h5l2-2h4l2 2h3v12z"/></svg>
        </div>
        <input type="file" id="camera-input" accept="image/*" capture="environment">

        <!-- Setup View -->
        <div id="setup-view" class="view">
            <div class="setup-form">
                <h2>Set up my QRME</h2>
                
                <!-- Section 0: App Theme -->
                <div class="settings-section">
                    <div class="section-title">App Theme</div>
                    <div class="theme-grid">
                        <div class="theme-swatch" style="background:#1c3e7d" onclick="window.setTheme('#1c3e7d')"></div>
                        <div class="theme-swatch" style="background:#0077B5" onclick="window.setTheme('#0077B5')"></div>
                        <div class="theme-swatch" style="background:#25D366" onclick="window.setTheme('#25D366')"></div>
                        <div class="theme-swatch" style="background:#8E24AA" onclick="window.setTheme('#8E24AA')"></div>
                        <div class="theme-swatch" style="background:#D32F2F" onclick="window.setTheme('#D32F2F')"></div>
                        <div class="theme-swatch" style="background:#F7931A" onclick="window.setTheme('#F7931A')"></div>
                        <div class="theme-swatch" style="background:#111111" onclick="window.setTheme('#111111')"></div>
                        <div class="color-picker-wrapper"><input type="color" class="color-picker-input" onchange="window.setTheme(this.value)"></div>
                    </div>
                </div>

                <!-- Section 1: Context & Greeting -->
                <div class="settings-section">
                    <div class="section-title">Context & Greeting</div>
                    <div class="form-grid">
                        <div class="input-group"><label>Event</label><input type="text" id="in-event" placeholder="Event Name"></div>
                        <div class="input-group"><label>Date</label><input type="date" id="in-date"></div>
                        <div class="input-group full-width">
                            <label>Location</label>
                            <div class="loc-row">
                                <input type="text" id="in-location" placeholder="City, Country">
                                <button class="loc-btn" onclick="window.fetchLocation()">üìç</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="greeting-btn" onclick="window.toggleGreetingEditor()">Edit Greeting Message</button>
                    <div id="greeting-editor">
                        <label style="font-size:10px; color:#555; margin-bottom:4px; display:block;">CUSTOM MESSAGE</label>
                        <textarea id="in-greeting" rows="4"></textarea>
                        <button class="regen-btn" onclick="window.generateDefaultGreeting()">‚Ü∫ Revert to Default Template</button>
                    </div>
                </div>

                <!-- Section 2: Personal Details -->
                <div class="settings-section">
                    <div class="section-title">Personal Details</div>
                    <div class="form-grid">
                        <div class="input-group full-width">
                            <label>Profile Photo</label>
                            <label class="file-btn">Choose Photo<input type="file" id="in-photo" accept="image/*" style="display: none;" onchange="window.handlePhotoUpload(this)"></label>
                        </div>
                        <div class="input-group"><label>Name</label><input type="text" id="in-name" placeholder="John Doe"></div>
                        <div class="input-group"><label>Company</label><input type="text" id="in-company" placeholder="Acme Inc"></div>
                        <div class="input-group full-width"><label>Website</label><input type="url" id="in-website" placeholder="https://example.com"></div>
                        <div class="input-group full-width"><label>Email (for vCard)</label><input type="email" id="in-email" placeholder="john@example.com"></div>
                    </div>
                </div>

                <!-- Section 3: Social Links -->
                <div class="settings-section">
                    <div class="section-title">Social Links</div>
                    <div class="form-grid">
                        <div class="input-group"><label>LinkedIn (URL)</label><input type="url" id="in-linkedin"></div>
                        <div class="input-group"><label>Calendly (URL)</label><input type="url" id="in-calendly" placeholder="calendly.com/..."></div>
                        <div class="input-group"><label>WhatsApp (Tel)</label><input type="tel" id="in-whatsapp"></div>
                        <div class="input-group"><label>Telegram (User)</label><input type="text" id="in-telegram"></div>
                        <div class="input-group"><label>X / Twitter (@)</label><input type="text" id="in-twitter"></div>
                        <div class="input-group"><label>Instagram (User)</label><input type="text" id="in-instagram"></div>
                        <div class="input-group"><label>Youtube</label><input type="text" id="in-youtube" placeholder="channel"></div>
                        <div class="input-group"><label>Discord (Link)</label><input type="url" id="in-discord" placeholder="invite"></div>
                        <div class="input-group"><label>GitHub (User)</label><input type="text" id="in-github" placeholder="username"></div>
                    </div>
                </div>

                <!-- Section 4: Utilities -->
                <div class="settings-section">
                    <div class="section-title">Utilities</div>
                    <div class="form-grid">
                        <div class="input-group"><label>WiFi Name</label><input type="text" id="in-wifi-ssid"></div>
                        <div class="input-group"><label>WiFi Pass</label><input type="text" id="in-wifi-pass"></div>
                        <div class="input-group full-width"><label>Bitcoin Wallet</label><input type="text" id="in-btc"></div>
                    </div>
                </div>

                <!-- Section 5: Custom Links -->
                <div class="settings-section">
                    <div class="section-title">Custom Links</div>
                    <div id="custom-links-container"></div>
                    <button class="add-link-btn" onclick="window.addCustomField()">+ Add custom link</button>
                </div>

                <!-- Section 6: Data Backup -->
                <div class="settings-section">
                    <div class="section-title">Data Backup</div>
                    <div class="data-btns">
                        <button class="data-btn" onclick="window.exportData()">‚¨á Export File</button>
                        <button class="data-btn" onclick="document.getElementById('file-import').click()">‚¨Ü Restore File</button>
                        <input type="file" id="file-import" style="display:none" onchange="window.importData(this)">
                    </div>
                </div>

                <button id="save-btn" class="save-btn" onclick="window.saveData()">Save & Launch</button>
            </div>
        </div>

        <!-- Home View -->
        <div id="home-view" class="view">
            <div class="profile-container">
                <img id="display-photo" class="profile-pic" alt="Profile">
                <div id="display-placeholder" class="profile-placeholder">Q</div>
            </div>

            <button id="btn-copy-greeting" class="copy-intro-btn" onclick="window.copyGreeting()">
                <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <span>Copy Intro</span>
            </button>

            <div class="grid-container" id="main-grid">
                <!-- Buttons generated by JS -->
            </div>
        </div>

        <!-- QR View -->
        <div id="qr-view" class="view">
            <div class="qr-card">
                <div id="qrcode"></div>
                <div class="qr-label" id="qr-title">Title</div>
                
                <button class="action-btn share-btn" onclick="window.shareProfile()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                    Share Link
                </button>
                
                <button id="open-app-btn" class="action-btn open-app-btn" onclick="window.openNativeApp()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    <span id="open-app-text">Open App</span>
                </button>
                
                <button id="vcard-dl-btn" class="action-btn vcard-dl-btn" onclick="window.downloadVCard()" style="display:none;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Save Contact
                </button>
            </div>
            <button class="back-btn" onclick="window.showHome()">&lt; Back</button>
            
            <!-- Camera Button Top Right -->
            <div id="camera-btn" class="camera-icon" onclick="document.getElementById('camera-input').click()">
                <svg class="camera-svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm8-12H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H4V4h5l2-2h4l2 2h3v12z"/></svg>
            </div>
            <input type="file" id="camera-input" accept="image/*" capture="environment">
        </div>
    </div>

    <div class="footnote">created with ‚ù§Ô∏è by Ouriel</div>

    <script>
        // Offline Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }

        // Global State
        window.greetingDirty = false;
        window.inputs = {};
        window.qrCodeObj = null;
        window.currentUrl = '';
        window.currentDeepLink = '';
        window.currentVCardBlob = null;
        window.profilePhotoData = null;
        window.selectedTheme = '#1c3e7d'; 
        window.customLinks = [];

        // Global DOM Elements Reference (populated in init)
        window.getInputs = function() {
            window.inputs = {
                name: document.getElementById('in-name'),
                company: document.getElementById('in-company'),
                website: document.getElementById('in-website'),
                email: document.getElementById('in-email'),
                event: document.getElementById('in-event'),
                location: document.getElementById('in-location'),
                date: document.getElementById('in-date'),
                linkedin: document.getElementById('in-linkedin'),
                telegram: document.getElementById('in-telegram'),
                whatsapp: document.getElementById('in-whatsapp'),
                twitter: document.getElementById('in-twitter'),
                instagram: document.getElementById('in-instagram'),
                youtube: document.getElementById('in-youtube'),
                discord: document.getElementById('in-discord'),
                github: document.getElementById('in-github'),
                wifiSSID: document.getElementById('in-wifi-ssid'),
                wifiPass: document.getElementById('in-wifi-pass'),
                btc: document.getElementById('in-btc'),
                calendly: document.getElementById('in-calendly')
            };
            return window.inputs;
        }

        window.init = function() {
            window.getInputs();
            if (window.inputs.date && !window.inputs.date.value) {
                window.inputs.date.valueAsDate = new Date();
            }

            const data = localStorage.getItem('qrme_data');
            
            if (!data) {
                window.switchView('setup');
                return;
            }

            try {
                const parsed = JSON.parse(data);
                if (parsed.theme) { window.selectedTheme = parsed.theme; window.updateTheme(window.selectedTheme); }

                for (const key in window.inputs) {
                    if (parsed[key] && window.inputs[key]) window.inputs[key].value = parsed[key];
                }
                
                document.getElementById('in-greeting').value = parsed.greeting || window.generateGreetingText(parsed);
                
                if(parsed.customLinks && Array.isArray(parsed.customLinks)) {
                    window.customLinks = parsed.customLinks;
                } else if (parsed.customUrl) {
                    window.customLinks = [{label: parsed.customLabel || 'Link', url: parsed.customUrl}];
                } else {
                    window.customLinks = [];
                }
                
                const container = document.getElementById('custom-links-container');
                container.innerHTML = '';
                if (window.customLinks.length > 0) {
                    window.customLinks.forEach(link => window.addCustomField(link.label, link.url));
                }

                if (parsed.photo) {
                    window.profilePhotoData = parsed.photo;
                    const disp = document.getElementById('display-photo');
                    if(disp) {
                        disp.src = parsed.photo;
                        disp.style.display = 'block';
                        document.querySelector('.profile-placeholder').style.display = 'none';
                    }
                }
                
                window.renderHomeGrid(parsed);
                
                const copyBtn = document.getElementById('btn-copy-greeting');
                if(copyBtn) copyBtn.style.display = parsed.name ? 'flex' : 'none';

                window.switchView('home');

            } catch (e) {
                console.error(e);
                window.switchView('setup');
            }
        };

        window.showSetup = function() {
            window.switchView('setup');
            getInputs(); 
            if(window.inputs.date && !window.inputs.date.value) window.inputs.date.valueAsDate = new Date();
            window.fetchLocation();
        };

        window.switchView = function(viewName) {
            const views = { 
                setup: document.getElementById('setup-view'), 
                home: document.getElementById('home-view'), 
                qr: document.getElementById('qr-view') 
            };
            Object.values(views).forEach(el => {
                if(el) el.classList.remove('active');
            });
            if(views[viewName]) views[viewName].classList.add('active');
            
            const settingsBtn = document.getElementById('settings-btn');
            if (viewName === 'home') {
                if(settingsBtn) settingsBtn.style.display = 'block';
                window.updateTheme(window.selectedTheme); 
            } else {
                if(settingsBtn) settingsBtn.style.display = 'none';
            }
            
            const camBtn = document.getElementById('camera-btn');
            if(camBtn) camBtn.style.display = (viewName === 'qr') ? 'block' : 'none';
        }

        window.addCustomField = function(label = "", url = "") {
            const container = document.getElementById('custom-links-container');
            const div = document.createElement('div');
            div.className = "custom-link-row";
            div.innerHTML = `
                <div style="flex:1;"><input type="text" placeholder="Label" class="custom-label input-group" value="${label.replace(/"/g, '&quot;')}" style="width:100%;margin:0;"></div>
                <div style="flex:2;"><input type="url" placeholder="URL" class="custom-url input-group" value="${url.replace(/"/g, '&quot;')}" style="width:100%;margin:0;"></div>
                <button onclick="this.parentElement.remove()" style="background:#ef4444; color:white; border:none; border-radius:6px; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer;">√ó</button>
            `;
            container.appendChild(div);
        }

        window.renderCustomGridIcons = function() {
            const oldIcons = document.querySelectorAll('.custom-dynamic');
            oldIcons.forEach(el => el.remove());

            const grid = document.getElementById('main-grid');
            const wifiBtn = document.getElementById('btn-wifi'); 

            window.customLinks.forEach((link, index) => {
                if(link.url) {
                    const div = document.createElement('div');
                    div.className = "app-icon custom-dynamic";
                    div.innerHTML = `
                        <svg class="icon-svg" viewBox="0 0 24 24" style="fill: #FF9500;"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                        <span class="icon-label">${link.label || 'Link'}</span>
                    `;
                    div.onclick = function() { window.openQR('custom', index); };
                    grid.insertBefore(div, wifiBtn);
                }
            });
        }

        window.setTheme = function(color) {
            window.selectedTheme = color;
            window.updateTheme(color);
            document.querySelectorAll('.theme-swatch').forEach(el => el.classList.remove('active'));
            const swatches = document.querySelectorAll('.theme-swatch');
            for (let s of swatches) { if (s.style.backgroundColor === color) s.classList.add('active'); }
        }

        window.updateTheme = function(color) {
            document.documentElement.style.setProperty('--theme-base', color);
            const bgLayer = document.getElementById('bg-layer');
            const qrView = document.getElementById('qr-view');
            if (bgLayer && (!qrView || !qrView.classList.contains('active'))) {
                bgLayer.style.background = `linear-gradient(180deg, ${color} 0%, #000000 100%)`;
            }
        }

        window.toggleGreetingEditor = function() {
            const editor = document.getElementById('greeting-editor');
            if (editor.style.display === 'none' || editor.style.display === '') {
                editor.style.display = 'block';
            } else {
                editor.style.display = 'none';
            }
        }

        window.generateGreetingText = function(data) {
            const d = data || {}; 
            const name = d.name !== undefined ? d.name : (window.inputs.name ? window.inputs.name.value : "");
            const company = d.company !== undefined ? d.company : (window.inputs.company ? window.inputs.company.value : "");
            const website = d.website !== undefined ? d.website : (window.inputs.website ? window.inputs.website.value : "");
            const event = d.event !== undefined ? d.event : (window.inputs.event ? window.inputs.event.value : "");
            const location = d.location !== undefined ? d.location : (window.inputs.location ? window.inputs.location.value : "");
            const dateRaw = d.date !== undefined ? d.date : (window.inputs.date ? window.inputs.date.value : "");

            let dateFormatted = "";
            if(dateRaw) {
                const parts = dateRaw.split('-');
                if(parts.length === 3) dateFormatted = `${parts[2]}/${parts[1]}/${parts[0]}`;
            }

            let parts = [];
            if(name) parts.push(`Hi, This is ${name}`);
            
            let contextParts = [];
            if(company) contextParts.push(`from ${company}`);
            if(website) contextParts.push(`(${website})`);
            if(contextParts.length > 0) parts.push(contextParts.join(" "));

            let meetingParts = [];
            if(dateFormatted || event || location) {
                meetingParts.push("We met");
                if(dateFormatted) meetingParts.push(`on ${dateFormatted}`);
                if(event) meetingParts.push(`at ${event}`);
                if(location) meetingParts.push(`in ${location}`);
            }
            
            if(meetingParts.length > 1) parts.push(meetingParts.join(" ") + ".");

            const appLink = "https://tryqrme.vercel.app/";
            
            let mainText = parts.length > 0 ? parts.join(", ") : "";
            if (mainText && !mainText.endsWith('.')) mainText += ".";

            return `${mainText}\n\nGet your own QRME at ${appLink}`;
        }

        window.generateDefaultGreeting = function() {
            window.greetingDirty = false; 
            window.getInputs();
            const currentData = {
                name: window.inputs.name.value,
                company: window.inputs.company.value,
                website: window.inputs.website.value,
                event: window.inputs.event.value,
                location: window.inputs.location.value,
                date: window.inputs.date.value
            };
            document.getElementById('in-greeting').value = window.generateGreetingText(currentData);
        }

        window.fetchLocation = function() {
            if (!navigator.geolocation) { return; } 
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const data = await response.json();
                    const addr = data.address;
                    const city = addr.city || addr.town || addr.village || addr.municipality || addr.county || '';
                    const country = addr.country || '';
                    const locField = document.getElementById('in-location');
                    if (city && country && locField) locField.value = `${city}, ${country}`;
                    else if (country && locField) locField.value = country;
                } catch (e) { console.log('Loc error', e); }
            }, () => console.log('Loc permission denied'));
        }

        window.copyGreeting = function() {
            const text = document.getElementById('in-greeting').value;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(showCopyFeedback).catch(() => tryFallbackCopy(text));
            } else {
                tryFallbackCopy(text);
            }
        }

        function tryFallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) showCopyFeedback();
            } catch (err) {}
            document.body.removeChild(textArea);
        }

        function showCopyFeedback() {
            if (navigator.vibrate) navigator.vibrate(50);
            const btn = document.getElementById('btn-copy-greeting');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span>Copied!</span>';
            btn.style.background = '#25D366'; 
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.style.background = 'rgba(255, 255, 255, 0.2)';
            }, 1500);
        }

        window.handlePhotoUpload = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const size = 150; 
                        canvas.width = size; canvas.height = size;
                        const minScale = Math.max(size/img.width, size/img.height);
                        const w = img.width * minScale; const h = img.height * minScale;
                        const x = (size - w) / 2; const y = (size - h) / 2;
                        ctx.drawImage(img, x, y, w, h);
                        window.profilePhotoData = canvas.toDataURL('image/jpeg', 0.8);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.saveData = function() {
            window.getInputs();
            const linkRows = document.querySelectorAll('.custom-link-row');
            window.customLinks = [];
            linkRows.forEach(row => {
                const l = row.querySelector('.custom-label').value.trim();
                const u = row.querySelector('.custom-url').value.trim();
                if(u) window.customLinks.push({label: l, url: u});
            });
            
            let greetingVal = document.getElementById('in-greeting').value;
            if (!window.greetingDirty) {
                 const currentData = {
                    name: window.inputs.name.value,
                    company: window.inputs.company.value,
                    website: window.inputs.website.value,
                    event: window.inputs.event.value,
                    location: window.inputs.location.value,
                    date: window.inputs.date.value
                };
                greetingVal = window.generateGreetingText(currentData);
                document.getElementById('in-greeting').value = greetingVal;
            }

            const data = {
                theme: window.selectedTheme,
                name: window.inputs.name.value.trim(),
                company: window.inputs.company.value.trim(),
                website: window.inputs.website.value.trim(),
                email: window.inputs.email.value.trim(),
                event: window.inputs.event.value.trim(),
                location: window.inputs.location.value.trim(),
                date: window.inputs.date.value.trim(),
                greeting: greetingVal,
                greetingDirty: window.greetingDirty, 
                linkedin: window.inputs.linkedin.value.trim(),
                telegram: window.inputs.telegram.value.trim(),
                whatsapp: window.inputs.whatsapp.value.trim(),
                twitter: window.inputs.twitter.value.trim(),
                instagram: window.inputs.instagram.value.trim(),
                youtube: window.inputs.youtube.value.trim(),
                discord: window.inputs.discord.value.trim(),
                github: window.inputs.github.value.trim(),
                wifiSSID: window.inputs.wifiSSID.value.trim(),
                wifiPass: window.inputs.wifiPass.value.trim(),
                btc: window.inputs.btc.value.trim(),
                calendly: window.inputs.calendly.value.trim(),
                customLinks: window.customLinks,
                photo: window.profilePhotoData
            };
            try {
                localStorage.setItem('qrme_data', JSON.stringify(data));
                
                const saveBtn = document.getElementById('save-btn');
                const originalText = saveBtn.innerText;
                saveBtn.innerText = "Settings Saved!";
                saveBtn.style.background = "#25D366";
                setTimeout(() => {
                    saveBtn.innerText = originalText;
                    saveBtn.style.background = "#000";
                    window.init(); 
                }, 800);
            } catch (e) {
                alert("Photo too large! Use a smaller one.");
            }
        }

        window.exportData = function() {
            const data = localStorage.getItem('qrme_data');
            if (!data) { alert("No data to export"); return; }
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qrme-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        window.importData = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && typeof data === 'object') {
                        localStorage.setItem('qrme_data', JSON.stringify(data));
                        alert('Data restored successfully!');
                        location.reload();
                    } else {
                        alert('Invalid file format.');
                    }
                } catch (err) {
                    alert('Error parsing file.');
                }
            };
            reader.readAsText(file);
        }

        window.addEventListener('load', function() {
            const greetingArea = document.getElementById('in-greeting');
            if(greetingArea) {
                greetingArea.addEventListener('input', function() {
                    window.greetingDirty = true;
                });
            }
            window.init();
        });
    </script>
</body>
</html>
