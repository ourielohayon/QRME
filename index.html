<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>QRME</title>

    <link rel="icon" type="image/png" href="/apple-touch-icon.png?v=135">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png?v=135">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --theme-base: #1c3e7d; 
            --bg-gradient: linear-gradient(180deg, var(--theme-base) 0%, #000000 100%);
            
            --linkedin-color: #0077B5; --telegram-color: #24A1DE; --whatsapp-color: #25D366;
            --twitter-color: #000000; --instagram-color: #C13584; --youtube-color: #FF0000;
            --discord-color: #5865F2; --github-color: #333333; --wifi-color: #5856D6;
            --bitcoin-color: #F7931A; --vcard-color: #333333; --share-app-color: #4B0082;
            --calendly-color: #006BFF; --custom-color: #FF9500;

            --card-bg: rgba(255, 255, 255, 0.94); 
            --text-primary: #000000;
            --ease: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { background-color: #000000; height: 100%; width: 100%; overflow: hidden; }
        
        body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background: transparent; overflow: hidden;
            display: flex; justify-content: center;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .app-background {
            position: fixed; top: -10vh; left: -10vw; width: 120vw; height: 120vh;
            background: var(--bg-gradient); z-index: -10; transition: background 0.6s ease;
        }

        #app { width: 100%; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; }

        .settings-icon {
            position: absolute; top: 20px; right: 25px; z-index: 100;
            color: rgba(255,255,255,0.6); padding: 10px; cursor: pointer;
        }
        .gear-svg { width: 24px; height: 24px; fill: currentColor; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }

        .camera-btn-fixed {
            position: absolute; top: 20px; right: 25px; z-index: 100;
            color: rgba(255,255,255,0.9); padding: 10px; cursor: pointer;
        }
        .camera-svg { width: 28px; height: 28px; fill: currentColor; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: opacity 0.3s var(--ease), transform 0.3s var(--ease);
        }
        .view.active { opacity: 1; pointer-events: all; transform: scale(1); }

        .profile-container { margin-bottom: 5px; position: relative; cursor: pointer; transition: transform 0.2s; }
        .profile-container:active { transform: scale(0.92); }
        .profile-pic {
            width: 100px; height: 100px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
            object-fit: cover; box-shadow: 0 8px 25px rgba(0,0,0,0.4); display: none; 
        }
        .profile-placeholder {
            width: 100px; height: 100px; border-radius: 50%;
            background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center;
            border: 2px dashed rgba(255,255,255,0.3);
        }
        .profile-placeholder svg { width: 40px; height: 40px; fill: rgba(255,255,255,0.6); }

        .profile-info { text-align: center; color: white; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .display-name { font-size: 20px; font-weight: 800; margin: 0; }
        .display-job-company { font-size: 13px; opacity: 0.8; margin: 2px 0 0; font-weight: 500; }

        .copy-intro-btn {
            background: rgba(255, 255, 255, 0.2); color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px;
            padding: 12px 20px; width: 100%; max-width: 360px;
            font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 15px; cursor: pointer; backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .grid-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            width: 100%; max-width: 360px; padding: 0 25px;
            max-height: 55vh; overflow-y: auto;
        }

        .app-icon {
            background: var(--card-bg);
            backdrop-filter: blur(20px); border-radius: 18px; padding: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
            height: 95px; transition: transform 0.1s;
        }
        .app-icon:active { transform: scale(0.96); }

        .icon-svg { width: 30px; height: 30px; display: block; }
        .icon-label { font-size: 13px; font-weight: 600; text-align: center; color: #000; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; }

        .add-qr-block { border: 2px dashed rgba(0,122,255,0.3); background: rgba(255,255,255,0.85); }
        .add-qr-label { font-size: 22px; font-weight: 400; color: #000; }
        .mini-icons { display: flex; gap: 6px; margin-top: 4px; }
        .mini-icons svg { width: 14px; height: 14px; }

        #qr-view { gap: 15px; }
        .qr-card {
            background: rgba(255,255,255,0.95); padding: 25px; border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); width: 260px;
        }
        #qrcode { width: 180px; height: 180px; background: white; border-radius: 4px; overflow: hidden; }
        #qrcode img { width: 100%; height: 100%; display: block; }
        .qr-label { font-size: 20px; font-weight: 700; text-align: center; margin: 0; }

        .action-btn {
            background: #007AFF; color: white; border: none; padding: 12px;
            font-size: 14px; font-weight: 600; border-radius: 12px; width: 100%;
            display: flex; justify-content: center; align-items: center; gap: 6px;
            cursor: pointer; transition: background 0.2s;
        }
        .action-btn:active { background: #0056b3; }
        
        .open-app-btn { background: transparent; color: #007AFF; border: 2px solid #007AFF; margin-top: -5px; }

        .back-btn {
            background: rgba(255, 255, 255, 0.15); color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.15); padding: 8px 24px;
            font-size: 15px; font-weight: 500; border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .setup-form {
            background: #fff; padding: 20px; border-radius: 20px;
            width: 95%; max-width: 400px;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding-bottom: 100px;
        }
        .setup-form h2 { margin: 0 0 10px; color: #000; font-size: 20px; text-align: center; font-weight: 800; }
        
        .settings-section {
            background: linear-gradient(180deg, #f0f9ff 0%, #e0f7fa 100%);
            border-radius: 12px; padding: 0; border: 1px solid #e0e7ff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 5px; overflow: visible;
        }
        
        .section-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-title { font-size: 11px; font-weight: 800; color: #0369a1; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .section-title svg { width: 14px; height: 14px; fill: #0369a1; }
        .chevron { transition: transform 0.3s ease; width: 16px; height: 16px; fill: #0369a1; }
        
        .section-content { display: none; padding: 0 15px 15px 15px; border-top: 1px solid rgba(0,0,0,0.05); margin-top: 0; }
        .settings-section.open .section-content { display: block; padding-top: 15px; }
        .settings-section.open .chevron { transform: rotate(180deg); }

        .settings-section.static .section-content { display: block; border-top: none; }
        .settings-section.static .section-header { cursor: default; padding-bottom: 5px; }
        .settings-section.static .chevron { display: none; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .input-group label { display: block; font-size: 10px; color: #555; margin-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px; background: #fff; border: 1px solid #ccc; 
            border-radius: 8px; font-size: 14px;
        }
        .full-width { grid-column: span 2; }
        
        .theme-grid { display: flex; gap: 4px; justify-content: space-between; padding: 8px 0; width: 100%; }
        .theme-swatch, .color-picker-wrapper { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; }
        .theme-swatch.active { border-color: #000; transform: scale(1.1); }
        .color-picker-wrapper { overflow: hidden; position: relative; background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); }
        .color-picker-input { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; opacity: 0; cursor: pointer; }

        .save-btn { width: 100%; padding: 14px; background: #000; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 10px; cursor: pointer; }

        .data-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 5px; }
        .data-btn { width: 100%; padding: 16px; background: #f2f2f7; color: #000; border: 1px solid #ddd; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; text-align: center; }

        .footnote { 
            position: absolute; bottom: 15px; width: 100%; 
            display: flex; justify-content: center; align-items: center; gap: 8px;
            color: #ffffff; font-size: 11px; font-weight: 500; pointer-events: auto; 
        }
        .footnote a { color: white; text-decoration: none; display: flex; align-items: center; }
        .github-footer-icon { width: 14px; height: 14px; fill: white; opacity: 0.8; transition: opacity 0.2s; }
        .github-footer-icon:hover { opacity: 1; }
        .file-btn { background: #fff; border: 1px solid #ccc; padding: 12px; border-radius: 8px; font-size: 14px; cursor: pointer; text-align: center; width: 100%; display:block; }

        /* iOS Install Prompt */
        .ios-prompt {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 360px;
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px; padding: 20px;
            color: white; z-index: 9999;
            display: none; flex-direction: column; align-items: center; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ios-prompt p { margin: 0 0 12px; font-size: 15px; font-weight: 500; line-height: 1.4; }
        .ios-prompt span { color: #0A84FF; font-weight: 700; }
        .ios-prompt-close { position: absolute; top: 10px; right: 15px; color: #888; font-size: 20px; cursor: pointer; padding: 5px; }
        .ios-share-icon { width: 18px; height: 18px; vertical-align: text-bottom; fill: #0A84FF; margin: 0 4px; display: inline-block; }
        
        @keyframes slideUp { from { bottom: -150px; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        .ios-prompt::after {
            content: ''; position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
            border-width: 12px 12px 0; border-style: solid; 
            border-color: rgba(30,30,30,0.95) transparent transparent transparent;
        }
    </style>
</head>
<body>

    <div class="app-background" id="bg-layer"></div>

    <!-- iOS Prompt HTML -->
    <div id="ios-install-prompt" class="ios-prompt">
        <div class="ios-prompt-close" onclick="closePrompt()">√ó</div>
        <p>Install <span>QRME</span> for the best experience!</p>
        <p style="opacity: 0.9; font-size: 14px;">Tap <svg class="ios-share-icon" viewBox="0 0 50 50"><path d="M30.3 13.7L25 8.4l-5.3 5.3-1.4-1.4L25 5.6l6.7 6.7z"/><path d="M24 7h2v21h-2z"/><path d="M35 40H15c-1.7 0-3-1.3-3-3V19c0-1.7 1.3-3 3-3h7v2h-7c-.6 0-1 .4-1 1v18c0 .6.4 1 1 1h20c.6 0 1-.4 1-1V19c0-.6-.4-1-1-1h-7v-2h7c1.7 0 3 1.3 3 3v18c0 1.7-1.3 3-3 3z"/></svg> below, then select <br><b>Add to Home Screen</b>.</p>
    </div>

    <div id="app">
        <div id="settings-btn" class="settings-icon" onclick="window.showSetup()">
            <svg class="gear-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        </div>

        <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none;" onchange="window.handlePhotoUpload(this)">
        <input type="file" id="library-input" accept="image/*" style="display:none;" onchange="window.handlePhotoUpload(this)">

        <!-- Setup View -->
        <div id="setup-view" class="view">
            <div class="setup-form">
                <h2>Set up my QRME</h2>
                
                <!-- 1. App Theme -->
                <div class="settings-section static visible">
                    <div class="section-header">
                        <div class="section-title"><svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z"/></svg> App Theme</div>
                    </div>
                    <div class="section-content">
                        <div class="theme-grid">
                            <div class="theme-swatch" style="background:#1c3e7d" onclick="window.setTheme('#1c3e7d')"></div>
                            <div class="theme-swatch" style="background:#0077B5" onclick="window.setTheme('#0077B5')"></div>
                            <div class="theme-swatch" style="background:#25D366" onclick="window.setTheme('#25D366')"></div>
                            <div class="theme-swatch" style="background:#8E24AA" onclick="window.setTheme('#8E24AA')"></div>
                            <div class="theme-swatch" style="background:#D32F2F" onclick="window.setTheme('#D32F2F')"></div>
                            <div class="theme-swatch" style="background:#F7931A" onclick="window.setTheme('#F7931A')"></div>
                            <div class="theme-swatch" style="background:#111111" onclick="window.setTheme('#111111')"></div>
                            <div class="color-picker-wrapper"><input type="color" class="color-picker-input" onchange="window.setTheme(this.value)"></div>
                        </div>
                    </div>
                </div>

                <!-- 2. Social Links -->
                <div class="settings-section static visible">
                    <div class="section-header">
                        <div class="section-title"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-2h2v2zm0-4H9V7h2v5z"/></svg> Social Links</div>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="input-group"><label>LinkedIn</label><input type="text" id="in-linkedin" placeholder="Username"></div>
                            <div class="input-group"><label>WhatsApp</label><input type="tel" id="in-whatsapp" placeholder="Tel"></div>
                            <div class="input-group"><label>Telegram</label><input type="text" id="in-telegram" placeholder="Username"></div>
                            <div class="input-group"><label>Instagram</label><input type="text" id="in-instagram" placeholder="Username"></div>
                            <div class="input-group"><label>Twitter/X</label><input type="text" id="in-twitter" placeholder="@handle"></div>
                            <div class="input-group"><label>YouTube</label><input type="text" id="in-youtube" placeholder="Channel ID"></div>
                            <div class="input-group"><label>Calendly</label><input type="text" id="in-calendly" placeholder="Calendly URL"></div>
                            <div class="input-group"><label>GitHub</label><input type="text" id="in-github" placeholder="Username"></div>
                            <div class="input-group full-width"><label>Discord</label><input type="text" id="in-discord" placeholder="Invite link"></div>
                        </div>
                    </div>
                </div>

                <!-- 3. Custom Link -->
                <div class="settings-section">
                    <div class="section-header" onclick="window.toggleSection('sec-custom-link', this)">
                        <div class="section-title"><svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg> Custom Link</div>
                        <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </div>
                    <div id="sec-custom-link" class="section-content">
                        <div class="form-grid">
                            <div class="input-group"><label>Label</label><input type="text" id="in-custom-label" placeholder="Portfolio"></div>
                            <div class="input-group"><label>URL</label><input type="url" id="in-custom-url" placeholder="https://..."></div>
                        </div>
                    </div>
                </div>

                <!-- 4. Context & Greeting -->
                <div class="settings-section">
                    <div class="section-header" onclick="window.toggleSection('sec-context', this)">
                        <div class="section-title"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 11H7V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/></svg> Context & Greeting</div>
                        <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </div>
                    <div id="sec-context" class="section-content">
                         <div class="form-grid">
                            <div class="input-group"><label>Event Name</label><input type="text" id="in-event"></div>
                            <div class="input-group"><label>Date</label><input type="date" id="in-date"></div>
                            <div class="input-group full-width">
                                <label>Location</label>
                                <div style="display:flex;gap:4px;">
                                    <input type="text" id="in-location" style="flex:1;">
                                    <button onclick="window.fetchLocation()" style="background:#007AFF;color:white;border:none;border-radius:8px;padding:0 8px;">üìç</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-group" style="margin-top:10px;">
                            <label>Greeting Text</label>
                            <textarea id="in-greeting" rows="4"></textarea>
                            <button onclick="window.generateDefaultGreeting()" style="background: #f1f5f9; border: none; font-size: 10px; color: #64748b; padding: 5px; width: 100%; border-radius: 4px; margin-top: 5px; cursor: pointer;">‚Ü∫ Re-generate from Context</button>
                        </div>
                    </div>
                </div>

                <!-- 5. Personal Details -->
                <div class="settings-section">
                    <div class="section-header" onclick="window.toggleSection('sec-personal', this)">
                        <div class="section-title"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> Personal Details</div>
                        <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </div>
                    <div id="sec-personal" class="section-content">
                        <div class="form-grid">
                            <div class="input-group full-width">
                                <label>Profile Photo</label>
                                <label class="file-btn">Choose Photo<input type="file" id="in-photo-settings" accept="image/*" style="display: none;" onchange="window.handlePhotoUpload(this)"></label>
                            </div>
                            <div class="input-group"><label>Full Name</label><input type="text" id="in-name"></div>
                            <div class="input-group"><label>Job Title</label><input type="text" id="in-job-title" placeholder="CEO / Designer"></div>
                            <div class="input-group full-width"><label>Company</label><input type="text" id="in-company"></div>
                            <div class="input-group full-width"><label>Website</label><input type="url" id="in-website" placeholder="https://..."></div>
                            <div class="input-group full-width"><label>Email (for vCard)</label><input type="email" id="in-email"></div>
                        </div>
                    </div>
                </div>

                <!-- 6. Utilities -->
                <div class="settings-section">
                    <div class="section-header" onclick="window.toggleSection('sec-utils', this)">
                        <div class="section-title"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg> Utilities</div>
                        <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </div>
                    <div id="sec-utils" class="section-content">
                        <div class="form-grid">
                            <div class="input-group"><label>WiFi Name</label><input type="text" id="in-wifi-ssid"></div>
                            <div class="input-group"><label>WiFi Pass</label><input type="text" id="in-wifi-pass"></div>
                            <div class="input-group full-width"><label>Bitcoin Address</label><input type="text" id="in-btc"></div>
                        </div>
                    </div>
                </div>

                <!-- 7. Backup -->
                <div class="settings-section">
                    <div class="section-header" onclick="window.toggleSection('sec-backup', this)">
                        <div class="section-title"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Data Backup</div>
                        <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </div>
                    <div id="sec-backup" class="section-content">
                        <div class="data-btns">
                            <button class="data-btn" onclick="window.exportData()">‚¨á EXPORT BACKUP FILE</button>
                            <button class="data-btn" onclick="document.getElementById('file-import').click()">‚¨Ü RESTORE FROM FILE</button>
                            <input type="file" id="file-import" accept=".json" style="display:none" onchange="window.importData(this)">
                        </div>
                    </div>
                </div>

                <button id="save-btn" class="save-btn" onclick="window.saveData()">Save & Launch</button>
            </div>
        </div>

        <!-- Home View -->
        <div id="home-view" class="view">
            <div class="profile-container" onclick="document.getElementById('library-input').click()">
                <img id="display-photo" class="profile-pic" alt="Profile">
                <div id="display-placeholder" class="profile-placeholder">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
            </div>

            <div id="profile-info-box" class="profile-info">
                <p id="display-name" class="display-name"></p>
                <p id="display-job-company" class="display-job-company"></p>
            </div>

            <button id="btn-copy-greeting" class="copy-intro-btn" onclick="window.copyGreeting()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <span>Copy Intro</span>
            </button>

            <div class="grid-container" id="main-grid"></div>
        </div>

        <!-- QR View -->
        <div id="qr-view" class="view">
            <div id="qr-camera-btn" class="camera-btn-fixed" onclick="document.getElementById('camera-input').click()">
                <svg class="camera-svg" viewBox="0 0 512 512"><path d="M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z"/></svg>
            </div>

            <div class="qr-card">
                <div id="qrcode"></div>
                <div class="qr-label" id="qr-title">Title</div>
                
                <button id="qr-action-btn" class="action-btn" onclick="window.shareProfile()">Share Link</button>
                
                <button id="open-app-btn" class="action-btn open-app-btn" onclick="window.openNativeApp()">
                    <span id="open-app-text">Open App</span>
                </button>
                
                <button id="vcard-dl-btn" class="action-btn" onclick="window.downloadVCard()" style="display:none;background:#333;">Save Contact</button>
            </div>
            <button class="back-btn" onclick="window.showHome()" style="margin-top:20px;">&lt; Back</button>
        </div>
    </div>

    <div class="footnote">
        created with ‚ù§Ô∏è by Ouriel
        <a href="https://github.com/ourielohayon/QRME" target="_blank" rel="noopener noreferrer">
            <svg class="github-footer-icon" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
        </a>
    </div>

    <!-- iOS Prompt -->
    <div id="ios-install-prompt" class="ios-prompt">
        <div class="ios-prompt-close" onclick="closePrompt()">√ó</div>
        <p>Install <span>QRME</span> for the best experience!</p>
        <p style="opacity: 0.9; font-size: 14px;">Tap <svg class="ios-share-icon" viewBox="0 0 50 50" style="width:18px;height:18px;vertical-align:text-bottom;fill:#0A84FF;"><path d="M30.3 13.7L25 8.4l-5.3 5.3-1.4-1.4L25 5.6l6.7 6.7z"/><path d="M24 7h2v21h-2z"/><path d="M35 40H15c-1.7 0-3-1.3-3-3V19c0-1.7 1.3-3 3-3h7v2h-7c-.6 0-1 .4-1 1v18c0 .6.4 1 1 1h20c.6 0 1-.4 1-1V19c0-.6-.4-1-1-1h-7v-2h7c1.7 0 3 1.3 3 3v18c0 1.7-1.3 3-3 3z"/></svg> below, then select <br><b>Add to Home Screen</b>.</p>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES & HELPERS ---
        window.brandColors = {
            linkedin: '#0077B5', telegram: '#24A1DE', whatsapp: '#25D366', twitter: '#000000',
            instagram: '#C13584', youtube: '#FF0000', discord: '#5865F2', github: '#333333',
            wifi: '#5856D6', bitcoin: '#F7931A', vcard: '#333333', 'share-app': '#4B0082',
            calendly: '#006BFF', custom: '#FF9500'
        };

        window.ICON_PATHS = {
            // FIXED WHATSAPP SVG (24x24 Centered)
            whatsapp: '<g transform="translate(1,1)"><path d="M18.89 3.04A10.7 10.7 0 0 0 11.23 0C5.07 0 .04 5.03.04 11.23c0 2.08.54 4.04 1.52 5.76L.33 22l5.12-1.34a10.65 10.65 0 0 0 5.77 1.7h.01c6.16 0 11.19-5.03 11.19-11.23 0-3-.12-5.83-2.28-7.98l-1.25-.11zM11.23 20.3a8.8 8.8 0 0 1-4.48-1.22l-.32-.19-3.32.87.89-3.24-.21-.33a8.83 8.83 0 0 1 14.28-4.96c.01 4.88-3.95 8.84-8.84 8.84l1.24.23zm4.84-6.62c-.27-.13-1.57-.77-1.81-.86-.24-.09-.42-.13-.6.13-.18.27-.69.86-.84 1.04-.15.18-.3.2-.57.07-.27-.13-1.12-.41-2.14-1.32-.79-.7-1.32-1.57-1.47-1.84-.15-.27-.02-.41.12-.55.12-.12.27-.3.4-.46.14-.15.18-.26.27-.44.09-.18.04-.34-.02-.48-.06-.13-.6-1.45-.82-1.99-.22-.52-.44-.45-.6-.45h-.51c-.18 0-.47.07-.71.34-.24.27-.92.9-.92 2.2s.95 2.56 1.08 2.74c.13.18 1.86 2.85 4.51 4 .63.28 1.12.45 1.51.57.64.2 1.22.17 1.68.1.51-.08 1.57-.64 1.79-1.26.22-.62.22-1.15.15-1.26-.07-.11-.24-.18-.51-.31z"/></g>',
            telegram: '<path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.894 8.221l-1.97 9.288c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.16.16-.295.293-.605.293l.213-3.053 5.56-5.022c.242-.213-.054-.334-.373-.121l-6.869 4.326-2.962-.924c-.643-.204-.657-.643.136-.953l11.553-4.458c.538-.196 1.006.128.847.932z"/>',
            linkedin: '<path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>',
            // FIXED INSTAGRAM GLYPH
            instagram: '<path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>',
            twitter: '<path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>',
            youtube: '<path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>',
            discord: '<path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419z"/>',
            github: '<path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>',
            share: '<path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>',
            bitcoin: '<path d="M16.5 10.5C16.5 9.12 15.38 8 14 8H10V6H8V8H6V10H8V16H6V18H8V20H10V18H13.5C15.43 18 17 16.43 17 14.5C17 13.1 16.18 11.9 15 11.3C15.9 10.9 16.5 10.1 16.5 9.25V10.5M10 10H13.5C14.05 10 14.5 10.45 14.5 11C14.5 11.55 14.05 12 13.5 12H10V10M10 16V14H13.5C14.05 14 14.5 14.45 14.5 15C14.5 15.55 14.05 16 13.5 16H10Z" />',
            calendly: '<path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/>',
            vcard: '<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>',
            wifi: '<path d="M12.01 6c-3.19 0-6.22 1.17-8.66 3.32l1.45 1.76C6.54 9.63 9.17 8.5 12 8.5c2.8 0 5.48 1.1 7.23 2.58l1.43-1.78C18.2 7.15 15.19 6 12.01 6zm0 5c-1.89 0-3.69.73-5.07 2.05L12 19l5.06-5.96C15.68 11.74 13.9 11 12.01 11z"/>',
            custom: '<path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>'
        };

        window.updateBackground = function(type) {
            const bgLayer = document.getElementById('bg-layer');
            let color = window.selectedTheme || '#1c3e7d';
            if (type !== 'home' && window.brandColors[type]) {
                color = window.brandColors[type];
            }
            bgLayer.style.background = `linear-gradient(180deg, ${color} 0%, #000000 100%)`;
        };

        window.switchView = function(viewName) {
            const vs = { setup: document.getElementById('setup-view'), home: document.getElementById('home-view'), qr: document.getElementById('qr-view') };
            Object.values(vs).forEach(v => v.classList.remove('active'));
            vs[viewName].classList.add('active');
            document.getElementById('settings-btn').style.display = (viewName === 'home') ? 'block' : 'none';
            if (viewName === 'home') window.updateBackground('home');
        };

        window.showSetup = function() {
            window.switchView('setup');
            window.fetchLocation();
        };

        window.getInputs = function() {
            window.inputs = {
                name: document.getElementById('in-name'),
                company: document.getElementById('in-company'),
                jobTitle: document.getElementById('in-job-title'),
                website: document.getElementById('in-website'),
                email: document.getElementById('in-email'),
                event: document.getElementById('in-event'),
                location: document.getElementById('in-location'),
                date: document.getElementById('in-date'),
                linkedin: document.getElementById('in-linkedin'),
                whatsapp: document.getElementById('in-whatsapp'),
                telegram: document.getElementById('in-telegram'),
                instagram: document.getElementById('in-instagram'),
                twitter: document.getElementById('in-twitter'),
                youtube: document.getElementById('in-youtube'),
                github: document.getElementById('in-github'),
                discord: document.getElementById('in-discord'),
                wifiSSID: document.getElementById('in-wifi-ssid'),
                wifiPass: document.getElementById('in-wifi-pass'),
                bitcoin: document.getElementById('in-btc'),
                calendly: document.getElementById('in-calendly'),
                customLabel: document.getElementById('in-custom-label'),
                customUrl: document.getElementById('in-custom-url'),
                greeting: document.getElementById('in-greeting')
            };
            return window.inputs;
        };

        window.fetchLocation = function() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const data = await response.json();
                    const addr = data.address;
                    const city = addr.city || addr.town || addr.village || '';
                    const country = addr.country || '';
                    document.getElementById('in-location').value = `${city}, ${country}`;
                } catch (e) {}
            });
        };

        window.init = function() {
            window.getInputs();
            const dataStr = localStorage.getItem('qrme_data');
            
            const today = new Date().toISOString().split('T')[0];
            window.inputs.date.value = today;

            window.switchView('home'); 

            if (dataStr) {
                try {
                    const parsed = JSON.parse(dataStr);
                    if (parsed.theme) { window.selectedTheme = parsed.theme; }
                    for (const key in window.inputs) { 
                        if (key !== 'date' && key !== 'location' && parsed[key] && window.inputs[key]) {
                            window.inputs[key].value = parsed[key]; 
                        }
                    }
                    
                    document.getElementById('display-name').innerText = parsed.name || '';
                    let jobComp = [parsed.jobTitle, parsed.company].filter(Boolean).join(' @ ');
                    document.getElementById('display-job-company').innerText = jobComp;

                    if (parsed.photo) {
                        window.profilePhotoData = parsed.photo;
                        document.getElementById('display-photo').src = parsed.photo;
                        document.getElementById('display-photo').style.display = 'block';
                        document.getElementById('display-placeholder').style.display = 'none';
                    }
                    window.renderHomeGrid(parsed);
                    document.getElementById('btn-copy-greeting').style.display = parsed.name ? 'flex' : 'none';
                } catch(e) { window.renderHomeGrid(null); }
            } else {
                window.renderHomeGrid(null);
                
                // Onboarding Logic for new user
                const prompt = document.getElementById('ios-install-prompt');
                if (prompt) {
                     // Check if iOS and not standalone
                    const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
                    const isStandalone = ('standalone' in window.navigator) && (window.navigator.standalone);
                    if (isIos && !isStandalone && !localStorage.getItem('qrme_install_prompt')) {
                        setTimeout(() => { prompt.style.display = 'flex'; }, 2000);
                    }
                }
            }
            window.updateBackground('home');
        };

        window.closePrompt = function() {
            document.getElementById('ios-install-prompt').style.display = 'none';
            localStorage.setItem('qrme_install_prompt', 'true');
        }

        window.renderHomeGrid = function(data) {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = '';
            const createBlock = (id, label, iconPath, onClick, isAdd = false) => {
                const div = document.createElement('div');
                div.className = `app-icon ${id} ${isAdd ? 'add-qr-block' : ''}`;
                if (isAdd) {
                    div.innerHTML = `
                        <div class="add-qr-label">${label}</div>
                        <div class="mini-icons">
                            <svg viewBox="0 0 24 24" style="fill:#25D366">${window.ICON_PATHS.whatsapp}</svg>
                            <svg viewBox="0 0 24 24" style="fill:#24A1DE">${window.ICON_PATHS.telegram}</svg>
                            <svg viewBox="0 0 24 24" style="fill:#0077B5">${window.ICON_PATHS.linkedin}</svg>
                            <svg viewBox="0 0 24 24" style="fill:#C13584">${window.ICON_PATHS.instagram}</svg>
                        </div>
                    `;
                } else {
                    div.innerHTML = `<svg class="icon-svg" viewBox="0 0 24 24" style="fill:var(--${id}-color, #333)">${iconPath}</svg><span class="icon-label">${label}</span>`;
                }
                div.onclick = onClick;
                return div;
            };

            if (!data) {
                grid.appendChild(createBlock('share-app', 'Get QRME', window.ICON_PATHS.share, () => window.openQR('share-app')));
                grid.appendChild(createBlock('add-qr', '+ Add QR', '', () => window.showSetup(), true));
            } else {
                grid.appendChild(createBlock('share-app', 'Get QRME', window.ICON_PATHS.share, () => window.openQR('share-app')));
                grid.appendChild(createBlock('vcard', 'Get vCard', window.ICON_PATHS.vcard, () => window.openQR('vcard')));
                if(data.linkedin) grid.appendChild(createBlock('linkedin', 'LinkedIn', window.ICON_PATHS.linkedin, () => window.openQR('linkedin')));
                if(data.whatsapp) grid.appendChild(createBlock('whatsapp', 'WhatsApp', window.ICON_PATHS.whatsapp, () => window.openQR('whatsapp')));
                if(data.telegram) grid.appendChild(createBlock('telegram', 'Telegram', window.ICON_PATHS.telegram, () => window.openQR('telegram')));
                if(data.instagram) grid.appendChild(createBlock('instagram', 'Instagram', window.ICON_PATHS.instagram, () => window.openQR('instagram')));
                if(data.calendly) grid.appendChild(createBlock('calendly', 'Calendly', window.ICON_PATHS.calendly, () => window.openQR('calendly')));
                if(data.wifiSSID) grid.appendChild(createBlock('wifi', 'WiFi', window.ICON_PATHS.wifi, () => window.openQR('wifi')));
                if(data.bitcoin) grid.appendChild(createBlock('bitcoin', 'Bitcoin Wallet', window.ICON_PATHS.bitcoin, () => window.openQR('bitcoin')));
                if(data.customUrl) grid.appendChild(createBlock('custom', data.customLabel || 'Link', window.ICON_PATHS.custom, () => window.openQR('custom')));
            }
        };

        window.exportData = function() {
            const dataStr = localStorage.getItem('qrme_data');
            if (!dataStr) return;
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "qrme_backup.json"; a.click();
            URL.revokeObjectURL(url);
        };

        window.importData = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    localStorage.setItem('qrme_data', JSON.stringify(data));
                    window.init();
                    location.reload(); 
                } catch (err) { alert('Error: Invalid file.'); }
            };
            reader.readAsText(file);
        };

        window.saveData = function() {
            window.getInputs();
            const data = {
                theme: window.selectedTheme,
                name: window.inputs.name.value.trim(),
                company: window.inputs.company.value.trim(),
                jobTitle: window.inputs.jobTitle.value.trim(),
                website: window.inputs.website.value.trim(),
                email: window.inputs.email.value.trim(),
                event: window.inputs.event.value.trim(),
                location: window.inputs.location.value.trim(),
                date: window.inputs.date.value.trim(),
                greeting: window.inputs.greeting.value,
                linkedin: window.inputs.linkedin.value.trim(),
                whatsapp: window.inputs.whatsapp.value.trim(),
                telegram: window.inputs.telegram.value.trim(),
                instagram: window.inputs.instagram.value.trim(),
                twitter: window.inputs.twitter.value.trim(),
                youtube: window.inputs.youtube.value.trim(),
                github: window.inputs.github.value.trim(),
                discord: window.inputs.discord.value.trim(),
                wifiSSID: window.inputs.wifiSSID.value.trim(),
                wifiPass: window.inputs.wifiPass.value.trim(),
                bitcoin: window.inputs.bitcoin.value.trim(),
                calendly: window.inputs.calendly.value.trim(),
                customLabel: window.inputs.customLabel.value.trim(),
                customUrl: window.inputs.customUrl.value.trim(),
                photo: window.profilePhotoData
            };
            localStorage.setItem('qrme_data', JSON.stringify(data));
            window.init(); 
        };

        window.handlePhotoUpload = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 150; canvas.height = 150;
                        ctx.drawImage(img, 0, 0, 150, 150);
                        window.profilePhotoData = canvas.toDataURL('image/jpeg', 0.8);
                        document.getElementById('display-photo').src = window.profilePhotoData;
                        document.getElementById('display-photo').style.display = 'block';
                        document.getElementById('display-placeholder').style.display = 'none';
                        const existing = localStorage.getItem('qrme_data');
                        if (existing) {
                            const p = JSON.parse(existing); p.photo = window.profilePhotoData;
                            localStorage.setItem('qrme_data', JSON.stringify(p));
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.setTheme = function(color) {
            window.selectedTheme = color;
            window.updateBackground('home');
            document.querySelectorAll('.theme-swatch').forEach(el => el.classList.remove('active'));
            const swatches = document.querySelectorAll('.theme-swatch');
            for (let s of swatches) { if (s.style.backgroundColor === color) s.classList.add('active'); }
        };

        window.toggleSection = function(id, header) {
            const content = document.getElementById(id);
            if (content.style.display === 'block') {
                content.style.display = 'none';
                header.parentElement.classList.remove('open');
            } else {
                content.style.display = 'block';
                header.parentElement.classList.add('open');
            }
        };

        window.openQR = function(p) {
            const dataStr = localStorage.getItem('qrme_data');
            const data = dataStr ? JSON.parse(dataStr) : {};
            let url = (p === 'share-app') ? window.location.href : (data[p] || window.location.href);
            let deepLink = '';

            if (p === 'whatsapp') { url = `https://wa.me/${data.whatsapp.replace(/\D/g,'')}`; deepLink = `whatsapp://send?phone=${data.whatsapp.replace(/\D/g,'')}`; }
            if (p === 'telegram') { url = `https://t.me/${data.telegram}`; deepLink = `tg://resolve?domain=${data.telegram}`; }
            if (p === 'instagram') { url = `https://instagram.com/${data.instagram}`; deepLink = `instagram://user?username=${data.instagram}`; }
            if (p === 'linkedin') { url = `https://linkedin.com/in/${data.linkedin}`; deepLink = url; }
            if (p === 'calendly') { url = data.calendly; deepLink = url; }
            if (p === 'bitcoin') { url = `bitcoin:${data.bitcoin}`; deepLink = 'zengo://'; }

            window.updateBackground(p);

            const qrBtn = document.getElementById('qr-action-btn');
            const qrTitle = document.getElementById('qr-title');
            const openBtn = document.getElementById('open-app-btn');
            const vcardBtn = document.getElementById('vcard-dl-btn');
            const openAppText = document.getElementById('open-app-text');

            openBtn.style.display = deepLink ? 'block' : 'none';
            vcardBtn.style.display = (p === 'vcard') ? 'block' : 'none';
            
            if (p === 'share-app') {
                qrTitle.innerText = "Share QRME";
                qrBtn.innerText = "Share Link";
                openBtn.style.display = 'none';
            } else if (p === 'bitcoin') {
                qrTitle.innerText = "BITCOIN WALLET";
                openAppText.innerText = "Open Zengo";
                qrBtn.innerText = "Share Link";
            } else {
                qrTitle.innerText = p.toUpperCase();
                openAppText.innerText = "Open App";
                qrBtn.innerText = "Share Link";
            }

            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById("qrcode"), { text: url, width: 180, height: 180 });
            window.switchView('qr');
        };

        window.openNativeApp = function() {
            if (window.currentDeepLink) window.location.href = window.currentDeepLink;
        };

        window.copyGreeting = function() {
            const msg = document.getElementById('in-greeting').value || "Meet QRME!";
            navigator.clipboard.writeText(msg);
            const btn = document.getElementById('btn-copy-greeting');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = "<span>Copied!</span>";
            btn.style.background = "#25D366";
            setTimeout(() => { 
                btn.innerHTML = originalHTML; 
                btn.style.background = "rgba(255, 255, 255, 0.2)";
            }, 1500);
        };

        window.downloadVCard = function() {
            const dataStr = localStorage.getItem('qrme_data');
            if (!dataStr) return;
            const data = JSON.parse(dataStr);
            let vCard = `BEGIN:VCARD\nVERSION:3.0\nN:;${data.name};;;\nFN:${data.name}\nTITLE:${data.jobTitle || ''}\nORG:${data.company}\nEMAIL:${data.email}\nURL:${data.website}\nEND:VCARD`;
            const blob = new Blob([vCard], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "contact.vcf"; a.click();
            URL.revokeObjectURL(url);
        };

        window.generateGreetingText = function(data) {
            const name = data.name || window.inputs.name.value || '...';
            const company = data.company || window.inputs.company.value || '...';
            const event = data.event || window.inputs.event.value || '...';
            const location = data.location || window.inputs.location.value || '...';
            const date = data.date || window.inputs.date.value || '...';
            return `Hi, I'm ${name} from ${company}. We met on ${date} at ${event} in ${location}.\n\nConnect with me: ${window.location.href}`;
        };

        window.generateDefaultGreeting = function() {
            window.inputs.greeting.value = window.generateGreetingText({});
        };

        window.toggleGreetingEditor = function() {
            const editor = document.getElementById('greeting-editor');
            if (editor.style.display === 'none' || editor.style.display === '') {
                editor.style.display = 'block';
            } else {
                editor.style.display = 'none';
            }
        }

        window.showSetup = function() { window.switchView('setup'); };
        window.showHome = function() { window.switchView('home'); };
        window.shareProfile = async function() {
            if (navigator.share) {
                try { await navigator.share({ title: 'My Profile', url: window.currentUrl || window.location.href }); } catch (err) {}
            } else { alert('Sharing not supported'); }
        };

        window.addEventListener('load', window.init);
    </script>
</body>
</html>
